<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BETA v0.2: Call Center Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        
        /* Styles from original QA checklist.html (some are no longer used) */
        .chevron {
            transition: transform 0.4s ease-in-out;
        }
        .chevron.rotate-180 {
            transform: rotate(180deg);
        }
        .task-section-content {
            transition: max-height 0.4s ease-in-out, padding-top 0.4s ease-in-out, padding-bottom 0.4s ease-in-out, opacity 0.3s ease-in-out;
            max-height: 1000px;
            overflow: hidden;
            opacity: 1;
        }
        .task-section-content.collapsed {
            max-height: 0;
            opacity: 0;
            padding-top: 0;
            padding-bottom: 0;
        }
        #main-content-wrapper.locked { /* This ID is no longer used, but style is kept for reference */
            opacity: 0.5;
            pointer-events: none;
        }
        #confirmation-modal-backdrop, #confirmation-modal-panel {
            transition: all 0.3s ease-in-out;
        }

        /* NEW STYLES FOR TABS */
        .tab-btn {
            transition: all 0.3s ease;
            border-bottom: 4px solid transparent;
        }
        .tab-btn.active {
            border-bottom-color: #2563EB; /* blue-600 */
            color: #2563EB; /* blue-600 */
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">

        <header class="text-center mb-8">
            <h1 class="text-3xl font-extrabold text-gray-900 dark:text-white mb-4">
                Call Center Tool (BETA v0.2)
            </h1>
            <nav class="flex justify-center border-b border-gray-300 dark:border-gray-700">
                <button id="tab-btn-generator" class="tab-btn active text-lg font-semibold py-4 px-6 focus:outline-none">
                    Template Generator
                </button>
                <button id="tab-btn-checklist" class="tab-btn text-lg font-semibold py-4 px-6 focus:outline-none">
                    QA Checklist
                </button>
            </nav>
        </header>

        <main id="tab-content-generator" class="tab-content">
            
            <div class="mb-6 bg-white dark:bg-gray-800 rounded-xl shadow-md">
                <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-t-lg">
                    <h2 class="text-lg font-bold text-gray-900 dark:text-white">1. Core Call Details</h2>
                </div>
                <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="gen-patient-type" class="block text-sm font-medium mb-1">Patient Type</label>
                        <select id="gen-patient-type" class="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600">
                            <option value="EP">Established Patient (EP)</option>
                            <option value="NP">New Patient (NP)</option>
                        </select>
                    </div>
                    <div>
                        <label for="gen-template-type" class="block text-sm font-medium mb-1">Template Type</label>
                        <select id="gen-template-type" class="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600">
                            <option value="scheduling">Allscripts - Scheduling</option>
                            <option value="pa-request">Nextech - Prior Auth</option>
                            <option value="refill-request">Nextech - Refill Request</option>
                            <option value="med-inquiry">Nextech - Medication Inquiry</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label for="gen-reason" class="block text-sm font-medium mb-1">Reason for Visit / Symptoms</label>
                        <input type="text" id="gen-reason" placeholder="e.g., Annual Exam, Flashes/Floaters" class="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600">
                    </div>
                    <div>
                        <label for="gen-referral" class="block text-sm font-medium mb-1">Referral Source</label>
                        <input type="text" id="gen-referral" placeholder="e.g., Dr. Smith, Google" class="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600">
                    </div>
                    <div>
                        <label for="gen-insurance" class="block text-sm font-medium mb-1">Insurance</label>
                        <input type="text" id="gen-insurance" placeholder="e.g., BCBS, Aetna" class="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600">
                    </div>
                    <div class="md:col-span-2">
                        <label for="gen-med-pharm" class="block text-sm font-medium mb-1">Medication / Pharmacy Info</label>
                        <input type="text" id="gen-med-pharm" placeholder="For Refill/PA/Inquiry only" class="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600">
                    </div>
                </div>
            </div>

            <div class="mb-6 bg-yellow-50 dark:bg-yellow-900/50 border-2 border-yellow-400 rounded-xl shadow-md">
                <div class="p-4 bg-yellow-100 dark:bg-yellow-800/60 rounded-t-lg">
                    <h2 class="text-lg font-bold text-yellow-800 dark:text-yellow-200">2. Mandatory Steps</h2>
                </div>
                <div class="p-6 space-y-6">
                    <div>
                        <h3 class="font-semibold mb-2 text-gray-800 dark:text-gray-200">HIPAA Authorization</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">Who is speaking? (For HIPAA note)</p>
                        <select id="gen-hipaa-auth" class="w-full md:w-1/2 p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600">
                            <option value="none">No note needed</option>
                            <option value="patient-temp">Patient gave temp auth</option>
                            <option value="patient-perm">Patient gave perm auth</option>
                            <option value="behalf-temp">Caller on behalf (temp auth)</option>
                            <option value="behalf-perm">Caller on behalf (perm auth)</option>
                        </select>
                        <div id="gen-hipaa-details" class="grid grid-cols-2 gap-4 mt-4 hidden">
                            <input type="text" id="gen-auth-name" placeholder="Authorized Name" class="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600">
                            <input type="text" id="gen-auth-relationship" placeholder="Relationship" class="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600">
                        </div>
                    </div>
                    
                    <div class="pt-4 border-t border-yellow-300 dark:border-yellow-700">
                        <h3 class="font-semibold mb-2 text-gray-800 dark:text-gray-200">Additional Notes</h3>
                        <div class="space-y-3">
                            <div class="flex items-center">
                                <input type="checkbox" id="gen-hmo" class="h-5 w-5 rounded text-blue-600 focus:ring-blue-500">
                                <label for="gen-hmo" class="ml-3">Patient aware of HMO referral</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="gen-copay" class="h-5 w-5 rounded text-blue-600 focus:ring-blue-500">
                                <label for="gen-copay" class="ml-3">Patient aware of CoPay/Deductible</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="gen-emergency" class="h-5 w-5 rounded text-blue-600 focus:ring-blue-500">
                                <label for="gen-emergency" class="ml-3">Emergency Appt (Approved by FD)</label>
                            </div>
                            <div id="gen-emergency-details" class="ml-8 hidden">
                                <label for="gen-fd-name" class="block text-sm font-medium mb-1">Front Desk Name who approved:</label>
                                <input type="text" id="gen-fd-name" placeholder="e.g., Sarah" class="w-full md:w-1/2 p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mb-6 bg-white dark:bg-gray-800 rounded-xl shadow-md">
                <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-t-lg">
                    <h2 class="text-lg font-bold text-gray-900 dark:text-white">3. Generated Template</h2>
                </div>
                <div class="p-6">
                    <button id="generate-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all duration-300 shadow-lg mb-4">
                        Generate Template
                    </button>
                    <textarea id="template-output" rows="10" class="w-full p-3 border rounded-md bg-gray-50 dark:bg-gray-900 dark:border-gray-700 dark:text-gray-200 font-mono text-sm" placeholder="Your generated template will appear here..."></textarea>
                    <button id="copy-btn" class="mt-4 bg-green-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-300 transition-all duration-300 shadow-lg">
                        Copy to Clipboard
                    </button>
                    <span id="copy-feedback" class="ml-4 text-green-600 font-medium hidden">Copied!</span>
                </div>
            </div>

        </main>

        <div id="tab-content-checklist" class="tab-content hidden">
            <div id="main-header" class="text-center mb-8">
                </div>
            
            <div id="scorecard-container" class="sticky top-0 z-10 mb-6"></div>

            <main>
                <div id="required-steps-container"></div>
                
                </main>

        </div>
    </div>
    
    <div id="confirmation-modal" class="fixed inset-0 z-50 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div id="confirmation-modal-backdrop" class="fixed inset-0 bg-gray-500 bg-opacity-75"></div>
        <div class="flex items-center justify-center min-h-full p-4 text-center sm:p-0">
            <div id="confirmation-modal-panel" class="relative bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl sm:my-8 sm:max-w-lg sm:w-full">
                <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 dark:bg-red-900 sm:mx-0 sm:h-10 sm:w-10">
                            <svg class="h-6 w-6 text-red-600 dark:text-red-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white" id="modal-title">Confirm Reset</h3>
                            <div class="mt-2"><p class="text-sm text-gray-500 dark:text-gray-400" id="modal-message">Are you sure? This action cannot be undone.</p></div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" id="modal-confirm-btn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm">Reset</button>
                    <button type="button" id="modal-cancel-btn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-500 shadow-sm px-4 py-2 bg-white dark:bg-gray-800 text-base font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        
        // --- MODIFIED SCRIPT FROM QA CHECKLIST.HTML ---
        
        // initialData now only contains requiredSteps.
        // Removed `sections` and `autoFails`.
        const initialData = {
            title: "💯 QA Score Checklist",
            description: "An interactive list for quality assurance scoring.",
            requiredSteps: {
                hipaa: [
                    { id: 'h1', text: 'Full Name', points: 2, completed: false },
                    { id: 'h2', text: 'Date of Birth', points: 2, completed: false },
                    { id: 'h3', text: 'FULL Address', points: 2, completed: false },
                    { id: 'h4', text: 'Phone Number', points: 2, completed: false },
                    { id: 'h5', text: 'Insurance', points: 2, completed: false},
                ],
                triage: {
                    prompt: 'Have you experienced any sudden or emergent Eye Problems?',
                    answered: null, // 'yes' or 'no'
                    questions: [
                         { id: 'q1', text: 'What type of vision problem are you experiencing?', points: 2, completed: false },
                         { id: 'q2', text: 'In which eye are you having problems? OD, OS or OU', points: 2, completed: false },
                         { id: 'q3', text: 'Have you recently had surgery?', points: 2, completed: false },
                         { id: 'q4', text: 'Are you having any pain? Use a scale of 1-10 (10 being the worst)', points: 2, completed: false },
                         { id: 'q5', text: 'Are you having any symptoms? (Burning, redness, tearing, itching, floaters, flashes of light, curtain/web/veil, sharp pain, light sensitivity, foreign body sensation)', points: 2, completed: false },
                         { id: 'q6', text: 'Are you having headaches with vision changes?', points: 2, completed: false },
                         { id: 'q7', text: 'How long have you been experiencing these symptoms?', points: 2, completed: false },
                         { id: 'q8', text: 'Do you wear contacts?', points: 2, completed: false },
                    ]
                }
            }
        };

        let checklistData;

        // --- Core Functions ---
        document.addEventListener('DOMContentLoaded', () => {
            // Load QA Checklist state
            try {
                const savedState = localStorage.getItem('qaChecklistState');
                if (savedState) {
                    const parsedState = JSON.parse(savedState);
                    // Modified check: only look for requiredSteps
                    if (parsedState && parsedState.requiredSteps) {
                        // Re-build data to ensure it matches new structure
                        checklistData = JSON.parse(JSON.stringify(initialData));
                        // Copy over saved progress for requiredSteps
                        checklistData.requiredSteps.hipaa = parsedState.requiredSteps.hipaa.map((savedItem, index) => ({
                           ...initialData.requiredSteps.hipaa[index],
                           ...savedItem,
                           id: initialData.requiredSteps.hipaa[index].id // Ensure IDs are from template
                        }));
                        checklistData.requiredSteps.triage.answered = parsedState.requiredSteps.triage.answered;
                         checklistData.requiredSteps.triage.questions = parsedState.requiredSteps.triage.questions.map((savedItem, index) => ({
                           ...initialData.requiredSteps.triage.questions[index],
                           ...savedItem,
                           id: initialData.requiredSteps.triage.questions[index].id // Ensure IDs are from template
                        }));
                    } else {
                        throw new Error("Saved state is outdated or invalid.");
                    }
                } else {
                    checklistData = JSON.parse(JSON.stringify(initialData));
                }
            } catch (e) {
                console.warn("Failed to load or parse saved state, starting fresh.", e);
                checklistData = JSON.parse(JSON.stringify(initialData));
            }

            // Render the checklist (it's hidden by default, but needs to be ready)
            renderFullChecklist();
            // Add all event listeners for both tabs
            addEventListeners();
            
            // --- NEW SCRIPT ---
            // Add listeners for the new generator tab
            addGeneratorEventListeners();
            // --- END NEW SCRIPT ---
        });
        
        function saveState() {
            localStorage.setItem('qaChecklistState', JSON.stringify(checklistData));
        }

        // Modified: Removed renderSections() and renderAutoFails()
        function renderFullChecklist() {
            renderHeader();
            renderScorecardStructure();
            renderRequiredSteps();
            updateScorecard();
        }
        
        // --- Render Functions ---
        function renderHeader() { 
            const headerEl = document.getElementById('main-header');
            if (headerEl) {
                headerEl.innerHTML = `<p class="text-md text-gray-600 dark:text-gray-400">${checklistData.description}</p>`;
            }
        }
        function renderScorecardStructure() { 
            const el = document.getElementById('scorecard-container');
            if(el) el.innerHTML = `<div class="bg-white/80 dark:bg-gray-900/80 backdrop-blur-sm p-4 rounded-xl shadow-lg"><div class="flex justify-between items-center mb-2"><h3 class="text-xl font-bold text-gray-800 dark:text-white">Total Score</h3><span id="score-display" class="text-2xl font-bold text-gray-900 dark:text-white"></span></div><div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-5"><div id="progress-bar-fill" class="h-5 rounded-full text-white text-xs font-bold flex items-center justify-center transition-all duration-500 ease-in-out" style="width: 0%;"></div></div><p id="autofail-warning" class="text-center text-red-500 font-bold mt-2 animate-pulse" style="display: none;">AUTO FAIL TRIGGERED</p></div>`; 
        }

        function renderRequiredSteps() {
            const el = document.getElementById('required-steps-container');
            if (!el) return;

            const { hipaa, triage } = checklistData.requiredSteps;
            const isHipaaComplete = hipaa.every(h => h.completed);
            
            let hipaaHTML = hipaa.map(item => `
                <div class="flex items-center mb-2">
                    <input type="checkbox" id="${item.id}" data-type="hipaa" class="required-checkbox h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer" ${item.completed ? 'checked' : ''}>
                    <label for="${item.id}" class="ml-3 flex-1 text-gray-800 dark:text-gray-200 cursor-pointer">${item.text}</label>
                </div>`).join('');
            
            let triageHTML = `
                <div id="triage-prompt-container" class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700 ${isHipaaComplete ? '' : 'hidden'}">
                    <p class="font-semibold text-gray-800 dark:text-gray-200">${triage.prompt}</p>
                    <div class="mt-2 space-x-4">
                        <label><input type="radio" name="triage-answer" value="yes" class="triage-radio" ${triage.answered === 'yes' ? 'checked' : ''}> Yes</label>
                        <label><input type="radio" name="triage-answer" value="no" class="triage-radio" ${triage.answered === 'no' ? 'checked' : ''}> No</label>
                    </div>
                </div>
                <div id="triage-questions-container" class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700 ${triage.answered === 'yes' ? '' : 'hidden'}">
                    ${triage.questions.map(q => `
                        <div class="flex items-center mb-2">
                            <input type="checkbox" id="${q.id}" data-type="triage-q" class="required-checkbox h-5 w-5 rounded" ${q.completed ? 'checked' : ''}>
                            <label for="${q.id}" class="ml-3 flex-1 text-sm text-gray-800 dark:text-gray-200">${q.text}</label>
                        </div>`).join('')}
                </div>
            `;

            el.innerHTML = `
                <div class="mb-6 bg-yellow-50 dark:bg-yellow-900/50 border-2 border-yellow-400 rounded-xl shadow-md">
                    <div class="p-4 bg-yellow-100 dark:bg-yellow-800/60 rounded-t-lg flex justify-between items-center">
                        <h2 class="text-lg font-bold text-yellow-800 dark:text-yellow-200">Required Steps</h2>
                        <button id="reset-button" class="bg-red-600 text-white font-bold py-1 px-4 rounded-lg hover:bg-red-700 focus:outline-none focus:ring-4 focus:ring-red-300 text-sm shadow-md">
                            Reset
                        </button>
                    </div>
                    <div class="p-4">
                        <h3 class="font-semibold mb-2 text-gray-800 dark:text-gray-200">HIPAA Verification</h3>
                        ${hipaaHTML}
                        ${triageHTML}
                    </div>
                </div>`;
        }
        
        // REMOVED: renderSections() function
        // REMOVED: renderAutoFails() function

        // --- Logic & State Management ---
        
        // REMOVED: checkRequiredStepsCompletion() function

        // Modified: calculateScore no longer checks for autofails or optional sections
        function calculateScore() {
            const { requiredSteps } = checklistData;
            
            let totalPossiblePoints = 0;
            let currentScore = 0;

            // Tasks now only come from requiredSteps
            const tasks = [
                ...requiredSteps.hipaa,
                ...requiredSteps.triage.questions
            ];

            for (const task of tasks) {
                if (task.points) {
                    totalPossiblePoints += task.points;
                    if (task.completed) {
                        currentScore += task.points;
                    }
                }
            }
            
            // isAutoFail is always false
            return { score: currentScore, total: totalPossiblePoints, isAutoFail: false };
        }

        // Modified: updateScorecard simplified, no longer handles autofail state
        function updateScorecard() {
            const { score, total } = calculateScore(); // isAutoFail is removed
            const scoreDisplay = document.getElementById('score-display');
            const progressBarFill = document.getElementById('progress-bar-fill');
            const autoFailWarning = document.getElementById('autofail-warning');
            
            if (!scoreDisplay || !progressBarFill || !autoFailWarning) return;

            const percentage = total > 0 ? (score / total) * 100 : 0;
            scoreDisplay.textContent = `${score} / ${total}`;
            scoreDisplay.className = `text-2xl font-bold text-gray-900 dark:text-white`;
            
            let colorClass = (percentage >= 90 ? 'bg-green-500' : (percentage >= 70 ? 'bg-yellow-500' : 'bg-orange-500'));
            
            progressBarFill.style.width = `${percentage}%`;
            progressBarFill.textContent = `${percentage.toFixed(0)}%`;
            progressBarFill.className = `h-5 rounded-full text-white text-xs font-bold flex items-center justify-center transition-all duration-500 ease-in-out ${colorClass}`;
            autoFailWarning.style.display = 'none'; // Always hidden
        }
        
        function showConfirmationModal(message, onConfirmCallback) { 
            const modal = document.getElementById('confirmation-modal');
            const modalMessage = document.getElementById('modal-message');
            const modalTitle = document.getElementById('modal-title');
            const confirmBtn = document.getElementById('modal-confirm-btn');
            const cancelBtn = document.getElementById('modal-cancel-btn');
            
            modalTitle.textContent = "Confirm Reset"; // Set title for reset
            modalMessage.textContent = message;
            confirmBtn.textContent = "Reset"; // Set button text for reset
            
            const confirmHandler = () => { onConfirmCallback(); hideConfirmationModal(); confirmBtn.removeEventListener('click', confirmHandler); cancelBtn.removeEventListener('click', cancelHandler); };
            const cancelHandler = () => { hideConfirmationModal(); confirmBtn.removeEventListener('click', confirmHandler); cancelBtn.removeEventListener('click', cancelHandler); };
            
            confirmBtn.addEventListener('click', confirmHandler);
            cancelBtn.addEventListener('click', cancelHandler);
            modal.classList.remove('hidden');
        }
        function hideConfirmationModal() { document.getElementById('confirmation-modal').classList.add('hidden'); }

        // --- Event Listeners ---
        function addEventListeners() {
            // --- NEW TAB SWITCHING LOGIC ---
            const genBtn = document.getElementById('tab-btn-generator');
            const checkBtn = document.getElementById('tab-btn-checklist');
            const genContent = document.getElementById('tab-content-generator');
            const checkContent = document.getElementById('tab-content-checklist');

            genBtn.addEventListener('click', () => {
                genBtn.classList.add('active');
                checkBtn.classList.remove('active');
                genContent.classList.remove('hidden');
                checkContent.classList.add('hidden');
            });
            checkBtn.addEventListener('click', () => {
                checkBtn.classList.add('active');
                genBtn.classList.remove('active');
                checkContent.classList.remove('hidden');
                genContent.classList.add('hidden');
            });
            // --- END NEW TAB LOGIC ---


            // --- MODIFIED QA LISTENERS ---
            
            // REMOVED: addSectionBtn listener

            // The 'reset-button' is now added dynamically inside renderRequiredSteps,
            // so we must use event delegation on `document.body` to catch its click.
            
            document.body.addEventListener('click', (event) => {
                const target = event.target;
                const button = target.closest('button');

                // Checkbox/Radio logic
                if (target.matches('.required-checkbox, .triage-radio')) {
                    handleCheckboxAndRadio(target);
                }
                
                // Reset Button logic
                if (button && button.id === 'reset-button') {
                     showConfirmationModal("Are you sure you want to reset the checklist to its original state?", () => {
                        localStorage.removeItem('qaChecklistState');
                        checklistData = JSON.parse(JSON.stringify(initialData));
                        renderFullChecklist();
                    });
                }

                // REMOVED: All listeners for .delete-section-btn, .delete-task-btn,
                // .add-task-btn, and .section-toggle
            });
        }
        
        // Modified: handleCheckboxAndRadio simplified
        function handleCheckboxAndRadio(target) {
            // Destructuring only requiredSteps
            const { requiredSteps } = checklistData;
            
            if (target.matches('.required-checkbox')) {
                const item = (target.dataset.type === 'hipaa' ? requiredSteps.hipaa : requiredSteps.triage.questions).find(i => i.id === target.id);
                if (item) item.completed = target.checked;
                renderRequiredSteps(); // Re-render to show/hide triage prompt
            }
            if (target.matches('.triage-radio')) {
                requiredSteps.triage.answered = target.value;
                renderRequiredSteps(); // Re-render to show/hide triage questions
            }
            
            // REMOVED: .task-checkbox handler
            // REMOVED: .autofail-checkbox handler
            
            updateScorecard();
            // REMOVED: call to checkRequiredStepsCompletion()
            saveState();
        }


        // --- NEW SCRIPT FOR TEMPLATE GENERATOR ---
        // (No changes in this section from v0.1)
        
        function addGeneratorEventListeners() {
            // Toggle visibility of HIPAA name/relationship fields
            document.getElementById('gen-hipaa-auth').addEventListener('change', (e) => {
                const details = document.getElementById('gen-hipaa-details');
                if (e.target.value === 'none') {
                    details.classList.add('hidden');
                } else {
                    details.classList.remove('hidden');
                }
            });

            // Toggle visibility of Emergency FD approval field
            document.getElementById('gen-emergency').addEventListener('change', (e) => {
                const details = document.getElementById('gen-emergency-details');
                if (e.target.checked) {
                    details.classList.remove('hidden');
                } else {
                    details.classList.add('hidden');
                }
            });

            // Main Generate Button
            document.getElementById('generate-btn').addEventListener('click', generateTemplate);

            // Copy to Clipboard Button
            document.getElementById('copy-btn').addEventListener('click', copyTemplateToClipboard);
        }

        function generateTemplate() {
            // Get all values from the form
            const templateType = document.getElementById('gen-template-type').value;
            const patientType = document.getElementById('gen-patient-type').value;
            const reason = document.getElementById('gen-reason').value || "N/A";
            const referral = document.getElementById('gen-referral').value || "N/A";
            const insurance = document.getElementById('gen-insurance').value || "N/A";
            const medPharm = document.getElementById('gen-med-pharm').value || "N/A";
            
            const hipaaAuth = document.getElementById('gen-hipaa-auth').value;
            const authName = document.getElementById('gen-auth-name').value || "[Name]";
            const authRel = document.getElementById('gen-auth-relationship').value || "[Relationship]";
            
            const isHmo = document.getElementById('gen-hmo').checked;
            const isCopay = document.getElementById('gen-copay').checked;
            const isEmergency = document.getElementById('gen-emergency').checked;
            const fdName = document.getElementById('gen-fd-name').value || "[FD Name]";

            let output = "";

            // Build the template based on type
            switch (templateType) {
                case 'scheduling':
                    // Allscripts Scheduling Template (4.1)
                    output += `${patientType} | ${reason} | ${referral} / ${insurance}\n\n`;
                    if (isCopay) {
                        output += "pt aware co/pay, ded- future eligibility ck\n";
                    }
                    if (isHmo) {
                        output += "pt aware HMO ref needed\n";
                    }
                    if (isEmergency) {
                        // Nextech Emergency Template (4.2)
                        output += `\n--- Nextech ER Note ---\n`;
                        output += `(${reason}) FD (${fdName}) Approved emergency appt.\n`;
                    }
                    break;
                
                case 'pa-request':
                    // Nextech Prior Auth (4.2)
                    output = `Spoke to pt and patient needs prior auth for (${medPharm}) sent to (${insurance}).`;
                    break;
                
                case 'refill-request':
                    // Nextech Refill (4.2)
                    output = `Spoke to pt and patient needs refill of (${medPharm}) sent to (${medPharm}).`;
                    break;
                
                case 'med-inquiry':
                    // Nextech Med Inquiry (4.2)
                    output = `Spoke to pt and they need clarity on (${medPharm}).`;
                    break;
            }

            // Add HIPAA Note if selected (4.1.3)
            if (hipaaAuth !== 'none') {
                output += "\n--- HIPAA Note ---\n";
                switch (hipaaAuth) {
                    case 'patient-temp':
                        output += `Spoke to pt and authorized (${authName} and ${authRel}) temporarily, to receive information and speak on behalf of (him/her).`;
                        break;
                    case 'patient-perm':
                        output += `Spoke to pt and authorized (${authName} and ${authRel}) permanently to receive information and speak on behalf of (him/her).`;
                        break;
                    case 'behalf-temp':
                        output += `(${authName} and ${authRel}) called on behalf of the patient and received a temporary verbal authorization to speak on behalf.`;
                        break;
                    case 'behalf-perm':
                        output += `(${authName} and ${authRel}) called on behalf of the patient and received a permanent verbal authorization to speak on behalf.`;
                        break;
                }
            }

            // Display the final template
            document.getElementById('template-output').value = output.trim();
        }

        function copyTemplateToClipboard() {
            const outputArea = document.getElementById('template-output');
            const feedback = document.getElementById('copy-feedback');

            if (navigator.clipboard && outputArea.value) {
                navigator.clipboard.writeText(outputArea.value).then(() => {
                    // Show feedback
                    feedback.classList.remove('hidden');
                    // Hide feedback after 2 seconds
                    setTimeout(() => {
                        feedback.classList.add('hidden');
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy text: ', err);
                });
            }
        }
        // --- END OF NEW SCRIPT ---

    </script>
</body>
</html>
